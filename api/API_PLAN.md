# TimeFlow API 规划

本文档概述了 TimeFlow 应用的 RESTful API 结构，旨在支持云同步等功能。

## API 设计原则

- **版本控制:** 大部分业务端点都以 `/api/v1` 作为前缀。
- **身份认证:** 受保护的端点需要在 `Authorization` 请求头中提供 JWT Bearer 令牌。
- **数据格式:** TimeFlow 客户端的请求和响应体优先采用 `application/protobuf` 格式；如不支持，则回退为 `application/json`。

---

## 0. 健康检查 API (`/ping`)

用于检查服务是否存活。

| 方法    | 端点         | 描述               | 认证       |
|:------|:-----------|:-----------------|:---------|
| `GET` | `/ping`    | 检查服务的可用性。        | &#10006; |
| `GET` | `/version` | 获取服务的构建版本和时间等信息。 | &#10006; |

---

## 1. 用户认证 API (`/auth`)

处理用户注册和登录，可公开访问。

| 方法     | 端点                             | 描述                                                             | 认证       |
|:-------|:-------------------------------|:---------------------------------------------------------------|:---------|
| `GET`  | `/auth/check-email`            | 检查指定的邮箱地址是否已经被注册。                                              | &#10006; |
| `POST` | `/auth/register`               | 使用邮箱、密码和收到的验证码注册一个新用户。                                         | &#10006; |
| `POST` | `/auth/send-verification-code` | 请求向指定邮箱发送一个注册验证码。                                              | &#10006; |
| `POST` | `/auth/login`                  | 用户登录并获取 JWT 令牌。                                                | &#10006; |
| `POST` | `/auth/logout`                 | 登出并撤销当前的 Refresh Token。                                        | &#10004; |
| `POST` | `/auth/refresh`                | 使用 Refresh Token 获取新的 Access Token。客户端可选择是否同时轮换 Refresh Token。 | &#10004; |

---

## 2. 课程表 API (`/schedules`)

管理用户的课程表集合。

| 方法       | 端点                        | 描述                   | 认证       |
|:---------|:--------------------------|:---------------------|:---------|
| `GET`    | `/schedules`              | 获取当前用户的所有课程表概要列表。    | &#10004; |
| `GET`    | `/schedules/{scheduleId}` | 获取指定 ID 的单个课程表的完整信息。 | &#10004; |
| `PUT`    | `/schedules/{scheduleId}` | 创建或完整更新指定 ID 的课程表。   | &#10004; |
| `DELETE` | `/schedules/{scheduleId}` | 删除指定 ID 的课程表。        | &#10004; |

---

## 3. 课程 API (`/schedules/{scheduleId}/courses`)

管理特定课程表内的课程。注意：这些操作也可以通过更新父级 `Schedule` 对象（通过 `PUT /schedules/{scheduleId}`）来间接实现。

| 方法       | 端点                                           | 描述                     | 认证       |
|:---------|:---------------------------------------------|:-----------------------|:---------|
| `GET`    | `/schedules/{scheduleId}/courses`            | 获取指定课程表下的所有课程概要列表。     | &#10004; |
| `GET`    | `/schedules/{scheduleId}/courses/{courseId}` | 获取指定 ID 的单个课程的完整信息。    | &#10004; |
| `PUT`    | `/schedules/{scheduleId}/courses/{courseId}` | 创建或更新指定课程表中的指定 ID 的课程。 | &#10004; |
| `DELETE` | `/schedules/{scheduleId}/courses/{courseId}` | 从指定课程表中删除指定 ID 的课程。    | &#10004; |

---

## 4. 用户 API (`/users/me`)

管理用户个人资料和偏好设置。

| 方法    | 端点                            | 描述              | 认证       |
|:------|:------------------------------|:----------------|:---------|
| `GET` | `/users/me`                   | 获取当前已登录用户的个人资料。 | &#10004; |
| `GET` | `/users/me/selected-schedule` | 获取当前选中的课程表。     | &#10004; |
| `PUT` | `/users/me/selected-schedule` | 更新当前选中的课程表。     | &#10004; |

> **注意**: 主题设置（主题模式、动态颜色、主题颜色等）属于本地 UI 偏好，应存储在客户端本地（如 DataStore），无需云端同步。

---

## 5. 云同步 API (`/sync`)

为提升用户体验，设计一个专门的、基于增量同步的端点，以减少网络请求次数。

| 方法     | 端点      | 描述                      | 认证       |
|:-------|:--------|:------------------------|:---------|
| `POST` | `/sync` | 执行一次完整的同步操作，交换本地与云端的变更。 | &#10004; |

### 同步流程示例:

1. **客户端到服务端**: 客户端发送一个 `POST` 请求，其中包含它上次同步的时间戳 (`lastSyncTimestamp`)，以及在本地发生的所有增、删、改操作。
2. **服务端到客户端**:
   服务器处理客户端的变更，然后找出从客户端上次同步至今，在云端发生的所有变更，最后将这些变更连同一个新的时间戳 (
   `newSyncTimestamp`) 一并返回给客户端。
