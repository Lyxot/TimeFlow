//// ---------------------------------
//// DBML for TimeFlow Application
//// ---------------------------------

Project TimeFlow {
  database_type: 'PostgreSQL'
  Note: 'Database schema for the TimeFlow application.'
}

Table Users as U {
  id int [pk, increment, note: 'Surrogate primary key']
  auth_id uuid [unique, not null, note: 'ID from the external authentication provider']
  username varchar(50) [not null]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
}

Table RefreshTokens as RT {
  id long [pk, increment]
  user_id int [not null]
  jti uuid [unique, not null, note: 'The unique ID (JWT ID) of the refresh token']
  expires_at timestamp [not null]
}

Table Schedules as S {
  id long [pk, increment, note: 'Surrogate primary key for internal relationships']
  user_id int [not null]
  local_id short [not null, note: 'Client-side ID, unique per user']
  name varchar(255) [not null]
  term_start_date date [not null]
  term_end_date date [not null]
  display_weekends bool [not null]
  lesson_time_period_info jsonb [not null, note: 'Serialized LessonTimePeriodInfo object']
  deleted bool [not null, default: false]
  
  indexes {
    (user_id, local_id) [unique]
  }
}

Table Courses as C {
  id long [pk, increment, note: 'Surrogate primary key']
  schedule_id long [not null]
  local_id short [not null, note: 'Client-side ID, unique per schedule']
  name varchar(255) [not null]
  teacher varchar(128)
  classroom varchar(128)
  time jsonb [not null, note: 'Serialized Range object']
  weekday int [not null, note: 'Stores ordinal of Weekday enum, as requested']
  color int [not null]
  weeks integer[] [not null, note: 'List of week numbers for the course']
  note text
  
  indexes {
    (schedule_id, local_id) [unique]
  }
}

// --- Relationship Definitions ---

Ref fk_Users_id_RefreshTokens {
  Users.id < RefreshTokens.user_id [delete: cascade]
}

Ref fk_Users_id_Schedules {
  Users.id < Schedules.user_id [delete: cascade]
}

Ref fk_Schedules_id_Courses {
  Schedules.id < Courses.schedule_id [delete: cascade]
}